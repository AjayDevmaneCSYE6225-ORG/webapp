name: packerbuild

# on:
#   pull_request:
#     types: [closed]
#     branches:
#       - main

on:
  pull_request:
    branches:
      - main
  workflow_dispatch :

jobs:
  packer-check:
    name: Packer Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build application artifact
        run: |
          zip -r webapp.zip .
          echo $(pwd)

      - name: Install Packer
        run: |
          wget https://releases.hashicorp.com/packer/1.7.5/packer_1.7.5_linux_amd64.zip
          unzip packer_1.7.5_linux_amd64.zip
          sudo mv packer /usr/local/bin/

      - name: packer init
        run: |
          cd Assignment02
          packer init packer

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.GCP_KEY2 }}

      # - name: packer build
      #   run: |
      #     cd Assignment02
      #     packer build packer

      - name: GET GCP IMAGE ID
        id: get_image_id
        run: |
            cd Assignment02
            IMAGE_ID=$(jq -r '.builds[-1].artifact_id' manifest.json | cut -d ":" -f2)
            echo "IMAGE_ID=$IMAGE_ID" >> $GITHUB_ENV
            echo "Built GCP image ID is $IMAGE_ID"
              
      - name: Generate version number
        id: versioning
        run: echo "VERSION=$(date +%s)" >> $GITHUB_ENV

      # Create a new Instance Template version
      - name: Create Instance Template version
        run: |
          gcloud compute instance-templates create csye-instance-template 
            --template=csye-instance-template 
            --source-instance=projects/csye6225-414121/global/images/my-final-custom-image 
            --machine-type=n1-standard-1 
            --boot-disk-size=100 
            --boot-disk-type=pd-balanced 
            --boot-disk-kms-key=projects/csye6225-414121/locations/global/keyRings/vm_key_3/cryptoKeys/vm_key_3 
            --network=projects/csye6225-414121/global/networks/vpc 
            --subnetwork=projects/csye6225-414121/regions/us-central1/subnetworks/webapp_subnet 
            --network-tier=PREMIUM 
            --tags=webapp 
            --metadata=startup-script=
              "#!/bin/bash
              sudo bash -c 'cat <<EOF > /opt/unzippedWebapp/Assignment02/.env
              DB_USERNAME=webapp
              DB_NAME=webapp
              DB_PASSWORD=Hello@123
              DB_HOST=localhost
              PORT=3000
              EOF'
              sudo chown -R csye6225:csye6225 /opt/unzippedWebapp/Assignment02
              sudo chmod -R 755 /opt/unzippedWebapp/Assignment02
              sudo systemctl restart csye6225.service"

      - name: Create instance template
        run: |
          TEMPLATE_NAME="webapp-template-$(date +%Y%m%d%H%M%S)"
          gcloud compute instance-templates create $TEMPLATE_NAME
          --machine-type=e2-standard-2 --instance-template-region=us-east1 
          --region=us-east1 --tags=webapp --image=$IMAGE_ID --boot-disk-size=40 
          --boot-disk-type=pd-ssd --boot-disk-device-name=terraform-instance 
          --network=csye6225-vpc 
          --subnet=webapp 
          --service-account=ops-agent@csye6225-dev-414900.iam.gserviceaccount.com 
          --scopes=https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/pubsub,https://www.googleapis.com/auth/cloudkms 
          --no-boot-disk-auto-delete 
          --boot-disk-kms-key=projects/csye6225-dev-414900/locations/us-east1/keyRings/webapp-key-ring-2/cryptoKeys/crypto-key-vm-2 
          --metadata startup-script='#!/bin/bash
          if [ ! -f /opt/webapp/.env ]; then
              sudo echo "MYSQL_HOSTNAME=10.206.0.2" | sudo tee -a /opt/webapp/.env
              sudo echo "MYSQL_PASSWORD=lYeE5VxczbEShFWM" | sudo tee -a /opt/webapp/.env
              sudo echo "MYSQL_DATABASENAME=webapp" | sudo tee -a /opt/webapp/.env
              sudo echo "MYSQL_USERNAME=webapp" | sudo tee -a /opt/webapp/.env
              sudo echo "PORT=8080" | sudo tee -a /opt/webapp/.env
              sudo echo "SALT_ROUNDS=10" | sudo tee -a /opt/webapp/.env
          fi
          sudo touch /opt/finish.txt
          sudo chown -R csye6225:csye6225 /opt/webapp/
          sudo chmod 700 /opt/webapp/
          ' --quiet

      # Update the managed instance group to use the new template
      - name: Update Managed Instance Group
        run: |
          gcloud compute instance-groups managed set-instance-template your-managed-instance-group \
            --template=csye-instance-template \
            --zone=your-zone

      # Start a rolling update for the managed instance group
      - name: Start Rolling Update
        run: |
          gcloud compute instance-groups managed rolling-action start-update your-managed-instance-group \
            --version=csye-instance-template \
            --zone=your-zone \
            --type=rolling-update

      # Wait for the managed instance group update to complete
      - name: Wait for Managed Instance Group Update
        run: |
          while [[ $(gcloud compute instance-groups managed describe your-managed-instance-group \
                    --zone=your-zone --format='value(versions.targetSize)' \
                    --filter='isStable = true') -lt 100 ]]; do
            echo "Waiting for managed instance group update to complete..."
            sleep 10
          done
